<!DOCTYPE html>
<html>
<head>
    <title>Cloudflare P2P Chat</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
        #chat { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        input { width: 80%; padding: 10px; }
    </style>
</head>
<body>
    <h2>P2P Chat</h2>
    <div id="chat"></div>
    <input type="text" id="message" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>

    <script>
        // 1. Connect to your Cloudflare Worker
        const socket = new WebSocket('wss://ww.wry.workers.dev/');
        let peer = null;

        socket.onopen = () => {
            console.log("Connected to Signaling Server");
            setupPeer(window.location.hash === '#init');
        };

        function setupPeer(isInitiator) {
            peer = new SimplePeer({ initiator: isInitiator, trickle: false });

            // When Peer generates signaling data, send it to the other person via Worker
            peer.on('signal', data => {
                socket.send(JSON.stringify(data));
            });

            // When the connection is established
            peer.on('connect', () => {
                appendMessage("System: Connected directly to peer!");
            });

            // When a message arrives via P2P
            peer.on('data', data => {
                appendMessage("Peer: " + data);
            });
        }

        // Handle signaling data coming from the Worker
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            peer.signal(data);
        };

        function sendMessage() {
            const msg = document.getElementById('message').value;
            peer.send(msg);
            appendMessage("You: " + msg);
            document.getElementById('message').value = '';
        }

        function appendMessage(text) {
            const div = document.createElement('div');
            div.textContent = text;
            document.getElementById('chat').appendChild(div);
        }
    </script>
</body>
</html>